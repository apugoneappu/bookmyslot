import requests
from cairosvg import svg2png
import logging
import cv2

logger = logging.getLogger(__name__)
FORMAT = "[%(filename)s:%(lineno)s - %(funcName)20s() ] %(message)s"
logging.basicConfig(level=logging.INFO, format=FORMAT)

json = {
    "captcha": "<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"150\" height=\"50\" viewBox=\"0,0,150,50\"><path fill=\"#111\" d=\"M103.58 37.81L103.61 37.84L103.73 37.97Q103.99 38.91 104.52 40.93L104.44 40.84L104.56 40.96Q100.28 39.57 95.67 39.84L95.65 39.82L95.62 39.79Q91.12 40.13 87.13 42.11L87.08 42.06L87.12 42.10Q87.34 41.41 87.38 41.48L87.33 41.44L87.44 41.55Q91.07 37.49 95.00 33.07L94.94 33.02L95.06 33.14Q99.53 28.20 100.71 23.52L100.62 23.43L100.63 23.44Q101.06 21.67 99.79 20.49L99.89 20.58L99.77 20.47Q98.57 19.36 96.78 19.51L96.68 19.42L96.83 19.56Q96.42 19.46 96.08 19.46L96.07 19.45L95.99 19.38Q94.49 19.40 93.23 20.31L93.22 20.29L93.26 20.33Q92.05 21.79 92.28 24.45L92.27 24.45L92.12 24.30Q90.38 24.01 89.17 23.55L89.13 23.52L89.13 23.52Q89.11 22.27 89.03 20.83L88.86 20.65L89.02 20.82Q88.88 19.12 89.49 17.98L89.46 17.95L89.54 18.02Q91.36 16.68 94.71 16.68L94.61 16.58L96.34 16.56L96.39 16.62Q98.55 16.53 99.50 16.64L99.55 16.69L99.59 16.73Q103.88 17.10 104.15 19.54L104.30 19.68L104.16 19.55Q104.18 20.07 104.11 20.87L104.12 20.88L104.15 20.91Q104.21 21.66 104.06 22.34L103.98 22.26L103.92 22.21Q102.37 30.40 94.80 37.25L94.76 37.22L94.85 37.31Q96.29 37.18 97.66 37.18L97.51 37.03L97.50 37.02Q100.75 37.04 103.61 37.84ZM103.15 17.13L103.01 16.99L103.15 17.13Q101.48 16.41 99.77 16.34L99.69 16.26L96.28 16.09L96.34 16.15Q91.86 15.85 89.65 16.96L89.64 16.95L89.71 17.01Q88.69 18.43 88.69 20.49L88.64 20.43L88.54 20.33Q88.61 21.09 88.91 23.91L89.07 24.07L88.94 23.94Q89.47 24.16 90.65 24.46L90.61 24.43L90.71 25.55L90.65 25.49Q90.56 25.90 90.64 26.43L90.83 26.62L90.80 26.59Q91.99 26.64 94.47 26.87L94.40 26.80L94.52 26.93Q94.35 26.41 94.35 26.07L94.40 26.12L94.45 26.17Q94.39 24.28 95.60 22.93L95.55 22.87L95.66 22.98Q96.90 21.66 98.69 21.77L98.60 21.67L98.56 21.64Q99.36 21.72 100.13 21.87L100.16 21.91L100.18 21.93Q100.30 22.31 100.38 22.73L100.34 22.69L100.35 22.70Q100.38 23.11 100.30 23.46L100.25 23.41L100.39 23.54Q99.13 28.30 94.71 33.13L94.55 32.97L94.66 33.08Q92.58 35.38 87.13 41.43L87.03 41.33L87.10 41.40Q86.98 42.31 86.64 42.88L86.63 42.87L86.60 42.83Q88.17 41.94 89.70 41.40L89.62 41.33L89.71 41.41Q88.99 41.99 88.04 43.48L87.98 43.41L88.00 43.43Q87.82 43.71 87.71 44.06L87.71 44.06L87.70 44.05Q92.73 42.15 98.21 42.34L98.07 42.20L98.18 42.31Q103.74 42.36 108.31 44.72L108.44 44.84L107.46 42.72L107.40 42.66Q106.82 41.39 106.55 40.59L106.43 40.48L106.51 40.55Q105.74 40.08 104.52 39.67L104.46 39.61L104.51 39.65Q104.26 38.84 103.88 37.46L104.03 37.62L103.93 37.51Q101.79 37.01 99.50 36.82L99.47 36.79L99.56 36.88Q104.22 32.28 105.74 24.02L105.66 23.94L105.79 20.99L105.88 21.08Q105.90 19.38 104.68 18.70L104.67 18.69L104.56 18.62L104.50 18.55Q104.42 18.44 104.34 18.44L104.48 18.58L104.48 18.57Q104.20 17.69 103.10 17.08Z\"/><path d=\"M12 6 C56 18,89 32,146 41\" stroke=\"#777\" fill=\"none\"/><path d=\"M7 39 C64 43,58 40,143 7\" stroke=\"#666\" fill=\"none\"/><path fill=\"#444\" d=\"M70.42 29.87L70.39 29.84L70.35 29.80Q70.12 29.80 69.82 29.80L69.81 29.79L69.91 29.90Q68.61 29.93 67.17 30.77L67.12 30.72L67.01 30.61Q65.80 31.84 65.80 33.74L65.72 33.67L65.75 33.69Q65.70 37.07 67.22 38.40L67.21 38.39L67.26 38.44Q68.25 39.65 70.53 39.65L70.47 39.60L70.44 39.56Q70.68 39.57 70.98 39.57L71.00 39.59L71.10 39.69Q72.87 39.74 74.01 38.11L74.00 38.09L73.88 37.98Q75.03 36.58 74.96 34.79L74.86 34.69L74.82 34.65Q74.97 34.27 74.97 33.85L75.04 33.92L75.05 33.93Q75.04 32.13 73.67 30.97L73.66 30.96L73.52 30.82Q72.20 29.71 70.41 29.86ZM74.93 40.06L74.99 40.12L74.93 40.05Q73.92 41.98 70.19 42.09L70.25 42.15L70.17 42.07Q66.71 42.12 65.11 40.52L65.08 40.49L65.07 40.47Q63.77 38.87 62.97 34.07L62.91 34.01L62.89 33.99Q62.65 32.30 62.65 31.04L62.62 31.02L62.70 31.10Q62.57 29.18 63.30 28.11L63.38 28.20L63.33 28.15Q64.66 26.74 67.63 26.74L67.67 26.78L67.73 26.84Q73.92 26.71 75.82 29.30L75.92 29.39L75.87 29.35Q76.10 28.59 76.52 26.99L76.53 27.00L76.43 26.90Q77.81 26.72 80.25 25.92L80.12 25.79L80.17 25.84Q77.80 31.54 77.57 37.86L77.50 37.79L77.52 37.81Q77.36 44.04 79.49 49.87L79.46 49.84L79.42 49.80Q77.68 49.16 75.89 48.90L75.93 48.93L75.90 48.90Q75.06 45.01 74.94 40.07ZM75.77 49.35L75.66 49.23L75.68 49.26Q76.36 49.37 77.77 49.67L77.88 49.78L77.77 49.67Q78.09 50.48 78.66 51.89L78.52 51.76L78.66 51.89Q81.11 52.48 83.40 53.77L83.49 53.87L83.48 53.86Q79.53 47.36 79.53 38.83L79.49 38.79L79.48 38.78Q79.52 32.46 81.99 26.67L81.84 26.52L82.02 26.70Q81.29 26.96 79.92 27.61L79.96 27.65L79.91 27.60Q80.15 26.73 80.80 25.17L80.81 25.19L80.90 25.27Q79.36 25.83 76.16 26.70L76.17 26.71L76.02 26.56Q76.02 27.24 75.71 28.43L75.75 28.46L75.66 28.37Q73.67 26.49 67.54 26.34L67.57 26.38L67.54 26.35Q64.31 26.24 62.94 27.72L62.89 27.68L62.87 27.65Q62.28 28.97 62.32 30.87L62.28 30.83L62.27 30.82Q62.32 33.76 63.31 37.53L63.44 37.66L63.33 37.55Q64.06 40.03 64.97 40.98L64.91 40.92L65.33 41.34L65.26 41.27Q66.43 44.04 71.87 44.27L71.91 44.31L71.82 44.22Q72.96 44.36 74.79 44.06L74.81 44.09L74.69 43.96Q75.01 46.91 75.62 49.19ZM72.38 32.25L72.26 32.13L72.25 32.12Q73.32 32.12 74.15 32.43L74.17 32.44L74.15 32.42Q74.33 32.94 74.44 33.55L74.45 33.56L74.54 33.65Q74.66 34.23 74.59 34.84L74.58 34.83L74.60 34.85Q74.60 36.75 73.57 38.04L73.54 38.01L73.41 37.88Q72.30 39.37 70.44 39.18L70.58 39.32L70.55 39.29Q69.13 39.17 68.18 38.75L68.29 38.85L68.33 38.90Q67.94 38.05 67.94 36.83L67.91 36.80L67.86 36.75Q67.81 36.40 67.81 36.09L67.91 36.19L67.95 36.24Q67.81 34.35 69.15 33.19L69.25 33.29L69.19 33.23Q70.56 32.11 72.31 32.18Z\"/><path fill=\"#111\" d=\"M39.78 41.16L39.66 41.04L39.76 41.14Q42.94 36.90 49.64 28.98L49.63 28.97L49.50 28.84Q43.75 29.22 39.98 27.85L39.92 27.79L39.95 27.82Q39.32 26.42 38.55 25.01L38.49 24.95L38.40 24.86Q42.61 26.48 47.06 26.52L47.02 26.48L47.00 26.46Q51.54 26.58 55.73 25.52L55.71 25.49L55.61 25.40Q55.35 26.20 55.08 26.73L54.94 26.59L54.96 26.61Q52.49 28.90 49.67 32.52L49.68 32.52L44.68 38.64L44.65 38.61Q46.98 38.50 49.23 38.58L49.21 38.56L49.17 38.53Q51.47 38.69 53.72 39.07L53.72 39.07L53.72 39.07Q53.87 39.68 54.59 41.70L54.61 41.71L54.57 41.68Q50.90 40.90 46.90 41.01L46.75 40.86L46.76 40.87Q42.91 41.10 39.26 42.28L39.15 42.17L39.18 42.20Q39.32 42.11 39.78 41.16ZM38.60 42.80L38.60 42.80L38.53 42.73Q39.39 42.49 40.99 42.07L41.11 42.19L41.03 42.11Q40.81 42.34 40.39 42.76L40.40 42.77L40.31 42.68Q40.08 43.25 39.47 44.39L39.52 44.45L39.49 44.41Q44.18 43.05 49.16 43.20L49.19 43.23L49.17 43.21Q54.11 43.35 58.68 45.21L58.74 45.28L58.66 45.19Q57.36 43.47 56.44 41.42L56.28 41.26L56.37 41.35Q55.54 40.97 54.47 40.74L54.49 40.76L54.45 40.72Q54.29 40.03 53.91 38.58L53.87 38.54L54.03 38.70Q52.36 38.25 48.78 38.13L48.94 38.29L48.95 38.30Q51.21 34.85 56.24 28.50L56.14 28.40L56.16 28.42Q56.48 27.75 57.17 26.42L57.21 26.46L54.86 27.16L54.87 27.16Q54.94 27.09 55.09 26.97L55.16 27.04L55.33 26.83L55.28 26.78Q55.82 25.80 56.39 24.85L56.33 24.78L56.32 24.77Q51.79 26.26 47.07 26.18L47.04 26.16L46.92 26.03Q42.20 26.04 37.71 24.21L37.74 24.24L37.66 24.16Q38.92 26.10 39.72 28.16L39.61 28.05L39.71 28.15Q40.44 28.34 41.50 28.61L41.50 28.61L41.51 28.62Q41.84 29.44 42.14 30.88L42.18 30.92L42.05 30.80Q43.66 31.07 46.97 31.22L46.97 31.22L47.01 31.26Q44.51 34.47 39.33 40.91L39.36 40.94L39.50 41.08Q39.22 41.63 38.65 42.85Z\"/><path d=\"M21 30 C63 14,92 22,133 33\" stroke=\"#333\" fill=\"none\"/><path fill=\"#444\" d=\"M26.01 29.50L25.90 29.39L25.96 29.45Q24.82 28.74 24.18 28.77L24.14 28.74L24.16 28.76Q22.86 28.90 21.81 29.91L21.75 29.85L21.78 29.88Q20.73 30.88 20.84 32.26L20.81 32.22L20.88 32.29Q21.16 36.60 20.28 41.13L20.26 41.11L20.17 41.03Q18.00 41.51 16.89 42.05L16.86 42.01L16.94 42.10Q18.37 37.86 18.15 33.40L18.19 33.44L18.15 33.40Q17.89 28.88 16.18 24.81L16.21 24.84L16.20 24.84Q17.42 25.59 19.70 26.24L19.77 26.31L20.25 28.92L20.32 28.99Q20.86 25.95 25.12 25.95L25.28 26.11L25.12 25.94Q25.52 25.89 25.83 25.89L25.98 26.05L25.80 25.87Q27.13 25.90 28.38 26.59L28.39 26.60L28.39 26.59Q27.18 28.05 26.04 29.53ZM27.66 31.53L27.65 31.37L27.68 31.40Q28.66 30.33 30.33 27.89L30.20 27.75L30.29 27.85Q29.76 27.43 28.23 27.16L28.37 27.29L28.24 27.17Q28.63 26.91 29.09 26.30L29.16 26.37L29.17 26.38Q27.20 25.41 25.26 25.60L25.26 25.59L25.33 25.66Q23.31 25.78 22.59 26.04L22.52 25.97L22.66 26.12Q21.15 26.43 20.35 27.54L20.37 27.55L20.21 26.75L20.02 25.91L20.07 25.97Q17.63 25.50 15.65 24.17L15.67 24.19L15.60 24.12Q17.64 28.41 17.87 33.28L17.89 33.30L18.00 33.41Q18.20 38.30 16.45 42.83L16.49 42.87L16.37 42.74Q17.45 42.26 18.33 41.96L18.45 42.08L18.44 42.07Q18.07 43.07 17.57 44.13L17.62 44.18L17.67 44.23Q20.43 43.30 22.56 43.19L22.53 43.15L22.71 38.62L22.81 38.71Q23.00 36.55 23.00 34.30L22.95 34.25L22.91 34.20Q23.01 33.13 23.93 32.16L23.73 31.96L23.91 32.14Q24.76 31.11 25.90 31.03L25.95 31.08L25.92 31.05Q26.55 30.92 27.27 31.60L27.23 31.56L27.66 31.53ZM22.66 29.73L22.57 29.57L22.70 29.81L22.62 29.69Z\"/><path fill=\"#333\" d=\"M118.39 26.87L118.34 26.82L118.41 26.89Q120.06 26.90 121.89 26.90L121.92 26.93L122.03 27.04Q123.83 27.06 125.66 26.90L125.49 26.74L125.66 26.91Q125.49 27.50 125.49 28.22L125.51 28.24L125.39 29.46L125.52 29.59Q123.07 29.50 118.31 29.61L118.31 29.61L118.30 29.60Q118.28 35.52 117.14 40.50L117.14 40.50L117.24 40.61Q114.98 41.24 113.50 42.04L113.42 41.96L113.41 41.96Q115.76 35.17 115.49 28.05L115.51 28.06L115.60 28.16Q115.34 21.00 112.67 14.34L112.67 14.34L112.59 14.26Q116.37 16.89 121.12 17.12L121.09 17.08L121.12 17.12Q125.69 17.20 129.84 15.45L129.94 15.55L129.87 15.47Q129.63 16.33 129.40 17.13L129.43 17.17L128.82 18.65L128.91 18.73Q126.12 19.75 123.15 19.91L123.24 19.99L123.18 19.94Q120.25 20.08 117.39 19.36L117.53 19.50L117.45 19.42Q118.12 22.80 118.31 26.79ZM130.50 14.77L130.50 14.77L130.47 14.74Q125.94 16.94 121.06 16.64L121.00 16.57L121.00 16.57Q115.81 16.41 112.08 13.56L111.90 13.38L112.07 13.55Q114.86 20.41 115.16 28.02L115.24 28.10L115.17 28.03Q115.59 36.07 113.08 42.84L113.06 42.82L112.94 42.71Q113.76 42.45 115.13 41.80L115.11 41.79L115.11 41.79Q114.78 42.41 114.21 43.93L114.29 44.02L114.25 43.98Q116.68 43.01 119.57 42.52L119.45 42.40L119.40 42.34Q120.09 37.56 120.28 31.85L120.35 31.92L120.29 31.85Q122.07 31.81 123.90 31.81L123.93 31.84L123.88 31.79Q125.74 31.86 127.57 32.05L127.53 32.02L127.56 32.05Q127.41 31.06 127.41 30.15L127.42 30.15L127.47 28.30L127.44 28.27Q126.61 28.32 125.78 28.32L125.81 28.35L125.80 28.34Q125.71 27.38 125.79 26.35L125.90 26.46L125.86 26.43Q124.52 26.64 123.11 26.64L123.07 26.61L123.17 26.71Q121.69 26.63 120.32 26.59L120.25 26.52L120.27 24.41L120.26 24.41Q120.27 23.35 120.16 22.28L120.11 22.24L120.00 22.12Q120.99 22.20 121.98 22.20L121.98 22.20L122.16 22.38Q126.79 22.25 130.41 20.35L130.38 20.32L130.36 20.30Q130.94 18.56 131.85 15.93L131.96 16.04L131.91 15.98Q130.58 16.79 129.78 17.13L129.69 17.04L129.84 17.19Q129.94 16.26 130.43 14.70Z\"/></svg>"
}

class Captcha():

	def __init__(self) -> None:

		self.url = "https://cdn-api.co-vin.in/api/v2/auth/getRecaptcha"

		self.payload = {}
		self.headers = {
			'authority': 'cdn-api.co-vin.in',
			'accept': 'application/json, text/plain, */*',
			'authorization': 'Bearer <AUTH_TOKEN_HERE>',
			'user-agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 11_3_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.114 Safari/537.36',
			'content-type': 'application/json',
			'sec-gpc': '1',
			'origin': 'https://selfregistration.cowin.gov.in',
			'sec-fetch-site': 'cross-site',
			'sec-fetch-mode': 'cors',
			'sec-fetch-dest': 'empty',
			'referer': 'https://selfregistration.cowin.gov.in/',
			'accept-language': 'en-GB,en-US;q=0.9,en;q=0.8'
		}
	
	def get(self, token):

		self.headers['authorization'] = f'Bearer {token}'

		response = requests.request("POST", self.url, headers=self.headers, data=self.payload)

		status = response.status_code
		if status == 200:
			data = response.json().get('captcha', '')
			msg = 'Successfully got captcha'
		elif status == 400:
			data = ''
			msg = response.json().get('error', '')
		else:
			data = ''
			msg = response.raw

		logger.info(f'{status}: {msg}')

		captcha = self.read_and_get_input(data)
		return captcha

	def read_and_get_input(self, data):

		svg2png(bytestring=data, background_color='white', write_to='output.png')
		cv2.namedWindow('window', cv2.WINDOW_AUTOSIZE)
		cv2.setWindowProperty('window', cv2.WND_PROP_TOPMOST, 1)

		captcha = ''
		while (len(captcha) < 5):
			img = cv2.imread('output.png')
			cv2.imshow('window', img)
			ret = cv2.waitKey(0)
			if (ret == 127):
				captcha = captcha[:-1]
			else:
				captcha += chr(ret)
			print(f'captcha input: {captcha}')

		cv2.destroyWindow('window')
		cv2.waitKey(2)
		
		logger.info(f'CAPTCHA: {captcha}')

		return captcha

if __name__ == '__main__':

	from otp import OTP
	import sys

	otp = OTP()
	txnId = otp.send_otp(8003115061)

	otp_recv = input('Please enter OTP: ')
	token = otp.validate_otp(otp_recv, txnId)
	if (token == ''):
		sys.exit('Invalid OTP!')

	captcha = Captcha()
	captcha_str = captcha.get(token)

	print(captcha_str)





